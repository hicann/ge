set(CMAKE_PREFIX_PATH ${CMAKE_PREFIX_PATH} ${ASCEND_ROOT}/tools/tikicpulib/lib)
find_package(tikicpulib QUIET)

# 要修复的目标列表
set(TIKICPULIB_TARGETS
        tikicpulib_ascend910B1
        tikicpulib_ascend910_9599
        # 添加其他可能出错的 target
)

foreach(tgt IN LISTS TIKICPULIB_TARGETS)
    if(TARGET ${tgt})
        # 修复 INTERFACE_INCLUDE_DIRECTORIES
        get_target_property(include_dirs ${tgt} INTERFACE_INCLUDE_DIRECTORIES)
        if(NOT include_dirs)
            set(include_dirs "")
        endif()

        set(valid_includes "")
        foreach(dir IN LISTS include_dirs)
            # 跳过明显错误的嵌套路径（可选）
            if(dir MATCHES "tools/tikicpulib/tools/tikicpulib")
                message(VERBOSE "Skipping malformed include dir: ${dir}")
                continue()
            endif()

            # 只保留真实存在的目录
            if(IS_DIRECTORY "${dir}")
                list(APPEND valid_includes "${dir}")
            else()
                message(VERBOSE "Skipping non-existent include dir: ${dir}")
            endif()
        endforeach()

        set_target_properties(${tgt}
                PROPERTIES INTERFACE_INCLUDE_DIRECTORIES "${valid_includes}"
        )

        # 同样修复 INTERFACE_LINK_DIRECTORIES（如有需要）
        get_target_property(link_dirs ${tgt} INTERFACE_LINK_DIRECTORIES)
        if(link_dirs)
            set(valid_links "")
            foreach(dir IN LISTS link_dirs)
                if(IS_DIRECTORY "${dir}")
                    list(APPEND valid_links "${dir}")
                endif()
            endforeach()
            set_target_properties(${tgt}
                    PROPERTIES INTERFACE_LINK_DIRECTORIES "${valid_links}"
            )
        endif()
    endif()
endforeach()

include_directories(${CODE_ROOT_DIR}/../../../../tests/autofuse/framework/share_graph/include)
include_directories(${CODE_ROOT_DIR}/../../../../tests/autofuse/st/backend_e2e)
include(backend_e2e.cmake)

add_subdirectory(mod_test)
add_subdirectory(load_log2_store_test)
add_subdirectory(load_lshift_store_test)
add_subdirectory(load_loop_mode_test)
add_subdirectory(add_abs_test)
add_subdirectory(add_rsqrt_test)
add_subdirectory(concat_test)
add_subdirectory(slice_concat_test)
add_subdirectory(continues_brc_test)
add_subdirectory(load_brc_test)
add_subdirectory(abs_brc_add_test)
add_subdirectory(scalar_brc_test)
add_subdirectory(cast_abs_test)
add_subdirectory(cast_nan_test)
add_subdirectory(cast_isfinite_test)
add_subdirectory(cast_reciprocal_test)
add_subdirectory(cast_abs_float16_float_test)
add_subdirectory(load_leaky_relu_store_test)
add_subdirectory(load_sigmoid_store_test)
add_subdirectory(load_erf_store_test)
add_subdirectory(load_tanh_store_test)
add_subdirectory(load_bitwise_and_store_test)
add_subdirectory(add_abs_int8_scalar_test)
add_subdirectory(add_abs_half_scalar_test)
add_subdirectory(add_abs_float_scalar_test)
add_subdirectory(ub_scalar_brc_abs_add_test)
add_subdirectory(add_exp2_test)
add_subdirectory(add_floor_test)
add_subdirectory(add_floor_bf16_test)
add_subdirectory(abs_fma_test)
add_subdirectory(abs_fma_bf16_test)
add_subdirectory(add_exp_bf16_test)
add_subdirectory(floordiv_abs_test)
add_subdirectory(brc_reduce_test)
add_subdirectory(floordiv_mul_le_select_test)
add_subdirectory(tail_brc_tail_reduce_test)
add_subdirectory(int32_logical_not_test)
add_subdirectory(int16_logical_not_test)
add_subdirectory(uint8_logical_not_test)
add_subdirectory(float_logical_not_test)
add_subdirectory(half_logical_not_test)
add_subdirectory(abs_clip_by_value_test)
add_subdirectory(load_logicalor_store_test)
add_subdirectory(load_logicaland_store_test)
add_subdirectory(load_gather_split_b_t_abs_store_test)
add_subdirectory(load_gather_tail_split_b_t_abs_store_test)
add_subdirectory(load_gather_one_axis_split_b_t_abs_store_test)
add_subdirectory(split_test)
add_subdirectory(load_where_x2_x3_is_ubscalar_store_test)
add_subdirectory(gather_reduce_store_test)
add_subdirectory(load_where_store_test)
add_subdirectory(load_where_x2_is_ubscalar_store_test)
add_subdirectory(load_where_x3_is_ubscalar_store_test)
add_subdirectory(load_compare_store_test)
add_subdirectory(load_compare_cast_sum_store_test)
add_subdirectory(scalar_div_inf_test)
add_subdirectory(matmul_elemwise_brc_test)
add_subdirectory(matmul_compare_scalar_test)
add_subdirectory(div_abs_test)
add_subdirectory(bf16_add_test)
add_subdirectory(bf16_nddma_add_test)
add_subdirectory(abs_bf16_test)
add_subdirectory(abs_uint8_test)
add_subdirectory(erf_bf16_test)
add_subdirectory(load_bitwise_not_store_test)
add_subdirectory(load_bitwise_or_store_test)
add_subdirectory(load_bitwise_xor_store_test)
add_subdirectory(ceil_bf16_test)
add_subdirectory(cos_bf16_test)
add_subdirectory(bf16_sin_test)
add_subdirectory(bf16_sqrt_test)
add_subdirectory(bf16_rsqrt_test)
add_subdirectory(bf16_sigmoid_test)
add_subdirectory(load_compare_scalar_where_store_test)
add_subdirectory(load_compare_where_store_test)
